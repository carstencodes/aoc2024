type Direction = 
    | Up
    | Down
    | Left
    | Right

type MapContentPart = 
    | Free
    | Obstacle

type PointInMap = int * int
type Route = (PointInMap * Direction) list

type MapLayout = Map<int, Map<int, MapContentPart>>

type Game = MapLayout * PointInMap * Direction * Route


let routePartToPointInRoute a =
    let pos, _ = a
    pos

let printGameWithObstacles (g: Game) obstacle =
    let matchInRoute route i j =
        route |> List.contains (i, j)

    let curPos i j pos =
        (i, j) = pos

    let dirToChar dir =
        match dir with
        | Up -> '^'
        | Right -> '>'
        | Left -> '<'
        | Down -> 'v'

    let map, pos, dir, routeWithDir = g
    let route = routeWithDir |> List.map routePartToPointInRoute

    for i in [0..(map.Count-1)] do
        let line = map[i]
        for j in [0..(line.Count-1)] do
            let content = line[j]
            let char = 
                match content with
                | Obstacle -> '#'
                | Free -> 
                    if curPos i j pos
                    then dirToChar dir
                    else
                        if matchInRoute obstacle i j 
                        then 'O'
                        else 
                            if matchInRoute route i j 
                            then 'X'
                            else '.'
            printf "%c" char
        printfn ""

let printGame (g: Game) = printGameWithObstacles g []

let getNextPos pos dir =
    let i, j = pos
    match dir with 
    | Up -> (i-1, j)
    | Left -> (i, j-1)
    | Right -> (i, j+1)
    | Down -> (i+1, j)

let isObstacle (map: MapLayout) postion =
    let i, j = postion
    let line = map[i]
    let point = line[j]

    point = Obstacle

let leavesMap dimOfMap pos =
    let x, y = pos
    let maxX, maxY = dimOfMap

    let leavesX = ((x < 0) || (x >= maxX))
    let leavesY = ((y < 0) || (y >= maxY))

    leavesX || leavesY

let rotate dir =
    match dir with
    | Up -> Right
    | Right -> Down
    | Down -> Left
    | Left -> Up

let singleElement seq =
    if (seq |> Seq.length <> 1) 
    then
        printfn "%A" seq
        failwith "Sequence contains more than one item"
    else seq |> Seq.item 0

let dim (map: MapLayout) =
    let dimX = map.Count
    if dimX = 0
    then (0, 0)
    else (dimX, map.Values |> Seq.map (fun f -> f |> Seq.length) |> Seq.distinct |> singleElement)

let rec gameRunsIntoLoop game = 
    let map, pos, dir, route = game
    let mapSize = dim map
    let nextPos = getNextPos pos dir

    if route |> List.contains (nextPos, dir)
    then true
    else 
        if leavesMap mapSize nextPos
        then false
        else
            if isObstacle map nextPos
            then gameRunsIntoLoop (map, pos, (rotate dir), route)
            else gameRunsIntoLoop (map, nextPos, dir, (route @ [nextPos, dir]))

let rec wouldBuildLoop game =
    let map, pos, dir, route = game

    let rotatedDir = rotate dir
    let newPos = getNextPos pos rotatedDir

    let newPotentialGame = map, newPos, rotatedDir, (route @ [newPos, rotatedDir])

    route |> List.contains (newPos, rotatedDir) || gameRunsIntoLoop newPotentialGame

let playMove game =
    let map, pos, dir, route = game
    let mapSize = dim map
    let nextPos = getNextPos pos dir

    if leavesMap mapSize nextPos
    then (map, pos, dir, (route @ [pos, dir])), true, None
    else
        if isObstacle map nextPos
        then (map, pos, (rotate dir), route), false, None
        else (map, nextPos, dir, (route @ [pos, dir])), false, if wouldBuildLoop game
                                                               then Some nextPos
                                                               else None


let playGame game =
    let mutable currentGame, finished = game, false

    while not finished do
        let nextGame, nextFinished, _ = playMove currentGame
        currentGame <- nextGame
        finished <- nextFinished

    currentGame

let playGameWithObstacles game =
    let mutable currentGame, finished , newObstacles= game, false, []

    while not finished do
        let nextGame, nextFinished, nextObstacle = playMove currentGame
        match nextObstacle with
        | Some p  ->
            newObstacles <- newObstacles @ [p]
        | _ -> ()
        currentGame <- nextGame
        finished <- nextFinished
        
    currentGame, newObstacles


let parse (t: string) =
    let lines = t.Split System.Environment.NewLine
    let mutable gameMap = Map.empty<int, Map<int, MapContentPart>>

    let mutable position = (-1, -1)
    let mutable currentDirection = Up

    for i in [0 .. ((lines |> Array.length) - 1)] do
        let changePositionAndMarkAsNoObstacle i j dir = 
            position <- (i, j)
            currentDirection <- dir
            Free

        let parseDirection c =
            match c with
            | '^' -> Up
            | '>' -> Right
            | '<' -> Left
            | 'v' -> Down
            | _ -> failwithf "Unexpected direction %c"c
        let line = (lines.[i]).ToCharArray()
        let mutable lineMap = Map.empty<int, MapContentPart>
        let indexedLine = Array.indexed line
        for (j, part) in indexedLine do
            let content = 
                match part with
                | '#' -> Obstacle
                | '.' -> Free
                | ('^' | '>' | '<' | 'v') -> changePositionAndMarkAsNoObstacle i j (parseDirection part)
                | _ -> failwithf "Unexpected character %c" part

            lineMap <- lineMap |> Map.add j content
        gameMap <- gameMap |> Map.add i lineMap

    let x, y = position
    assert (x >= 0)
    assert (y >= 0)

    (gameMap, position, currentDirection, [])
                

let example = """....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#..."""

let input = """.#....#...................#................#......................#.#...............#................#....#...........#..........#
.................................#.....#............#............#.......#...#...##........#..............................#.......
..............#.#............#...............................................##.................#....................#..#.........
..............#.............................#...........................#....#....#........#.................................#..#.
............#.#..#.#...........................#.....................................#..........#............#....................
.#......................................................................#..................................#......#............#.#
...........#.............................#....................#...#.....#........#....##.........................................#
......#..##.......................................................................#............#..................................
........#.......#..........#.......#........#..................#....................#.............#.....................#.........
................#....#.##.........................#........#....#.................#...............................................
.............#........................................#....................#...............#.....#.............#...............#..
..........#.........................#...#.......................#.............................................#......#............
........#................................................#..........#.............#.............#.........#....................#..
....#............#................#.....#.#................#..................#.................#.................................
....#.........................#.............#.....#..................#....#............#...................................#......
...##....................#.............#...............................................#..........................................
.....##.......................#...................#................#..........#.....................#...................#.........
....#....#..................................................#.......................................................#.............
...#........##.........................#.......................#........#...................#...........#...................#.....
.....................##.#...................................................................#.............#.......................
........#..............#...................................................#.....................#...#.......#..#.............#...
..................................................#.......#...............#.............#........#..#.....................#.......
..#..................#...............##..................#.#.........#..........#..............#....................#..#..........
...#..................................................#...........................................#........#......................
#.................................................#..............#...#..........#....................#....................#......#
..#...#....#...........#.................................#......................................#.......................#.....#...
...#...........#..#................................#......#.............#........................##.................#....#....#...
....................#.........#.......................................................................................#...........
............................................................#................#.#..#.....#.....................#...................
.......................................#......#....................................#........................................#.....
...........#.............#...............................#..........#.........#...#.......................................#.......
.............#...............................#.#...................................................#.....#............#...........
.......................................#...#....................#.#..........##.................#...............#............#....
....................#..#....#.............#..............#....#.........................................#.##.....#................
......##..............................................................................................#...........................
....#.......#.............................#..#.........#................................#.........#...............................
..........................................................................#...............................#...........#.#.........
...............#..................................................#.........#.....................#...............#...............
.........#......#............#.........#................................#..............................##.........................
...............#.....................................#............................................#........................#......
..#...........#...........................................#.........................................................#.............
................................#......##..#............................................................................#.........
.........#...........................................#....#..............#......................##....#..#........................
.....#.............#.....#........##......................#...#..................................................#.........#..#.#.
...........................#.........#.......#..........................##...........................#..............#.............
...............................................................................#..#........................#................#.#...
.....#.#.............................................................#.........#...........#..................................#...
.....#....#..#........#....................................#......................................................................
#......................................#..#..............................#..#................#........#...........................
.....................................................................................................#.......#....#.........#.....
....#....#............................................#................................................................#..........
......#.................#.......#..............................................#...................#..............................
...................#.........................................................................................#....................
.............................#................#.#......#...#.......................................#............#............#....
...........................................................#..........#..#.................##.....#..#............................
.....#......................................................#..............................#........................#.............
...............................................#.............#........#.......................................#.......#...........
.............................................................#.............................#...........#.#...................#....
.......#......#......#......................#..................................#^.......................#.........#.......#.......
...........................................................................................................#....................#.
.....#............#.....................#....................#....................................................................
....#...........#................#.....##.............................................................#....................#......
.................................#.#....................#......................#......................#.#.................#.......
..................#......#...#..........#............#................#...#.................................................#.....
...............................................................................................................#...#.........#....
...............#.........#..............................#.......#.......#.......#.................................................
.#........#...#......................................#........#...#.......................................................#..#....
.....#...............................................................#.....#..........#.........#.....................#...........
.........................................................................................................#...#.........#......#...
.....##..................#...#.....#.........#......................................#...............................#.............
..#...............................................................................................#...............................
........#..............................#.#........#.#..#...................................................#.#....................
........................................................#........................#..#.............................................
.....................#.......................#..................................#..........................#....#.................
.........................##.........#.................................#................................#....#.....................
..#........#.......................................................................#.....#........................................
.....#.....................................#.....#....................#...............#...........................................
......................#....................................................................................................#......
...#.........................#......................................................#.......#.......#..#.....................#....
............#...#....................................................#....#......#...............#.......#......................##
.......#.................................................#...#.....................#..................#...........................
.#...................#.....#.#..............................................................................#.....................
..........#...............#......#...........#......................................................#.....#.............#...#....#
.......##.........#.....................................................#....#.........................................#.........#
..##..................#............#..#........................................#..................#..##...........................
..................#....##..............................#.....#...............#.................................................#..
........#..........#...................#.............#...............#..#........#................................................
........#..............................................##....#....................................................................
.........#.#............#.........................#..............#................................#......................#........
........#.#............................#.....#....................................................................#...............
.......................................#......................#...........................#.......................................
..........................##.....................##..#............................................................................
#.............#..............................................................................#...........#........................
......#....#.....................................#........................#.......................................................
#...................#.#.......#.......#.....................#.....#...........................................#...................
...#.......................................#............................................#................#........................
...........#.............................#........................................................................................
...............................................................#.............#..................................................#.
.........#........#....#.#..............................................#.........................................................
.........#....#....#...................#..........#............................................#..##..............................
....#...#.......................#..#....................#...#..........................##..#....#.........................#.......
....#.....##...........................#.#..............#.......................#...#.......................................#.....
......................................................................................#.#..#.....#............##....#....#........
..............#..................................................................##....#.............#............................
................##...#..............#........................#.......................#.#...#......................#...............
...#............................#...#......#.#............#........#......................#........#................#.............
..........#.....................................#.....#...............................................................#.........##
.........#.......#...................#.#.........................................................#................................
...........................#.#............................#...................#.................#.........#.......................
.....#....#.........#................................................................................#...#..................#.....
...............................#....#............................#............................................#.............#.....
......#...............#......#.........................#.#........................................................................
.......................................................................................#...................#.........#.#..#.......
.....#...................................#..................................................................#........#............
...........................................#.......................................#....................#............#...#........
....#............................#..................................#.#....#......................#....#..#.......#...#...........
.#....#................................................#..................#.......##..........................#...#...............
........#...................##...........................................................#...................................#.#..
...#..........#.#....#...................#......#................................................................#................
....#............................#....#......#..#............#..................#........#..........#....#....#........#.#........
................#....#...............#...#.#..............................................#............#................#.........
.......#.....#.#.................#......................................................................#..#......................
.#......................#.................................................#......#..........#......#....................#.........
......#.#............................#............#.......#............#.....#....................................................
.#.............#.........#..................................................#...#...........#..........#............#..#..........
...........#......#...........#............................#.......#......#......#..........#....##..#............#...............
..........................#........#.........................................................#......#........................##...
.................#....#............#...#...........................#....#....#....#...#...........................................
.............#.......................................................#.........#..................................................
....#.................................#...............#.....#....#......##..............#.......................#........#........"""

let parsed = parse input
let finished, newObstacles = playGameWithObstacles parsed
printGame parsed

// let _, _, _, route = finished

printfn "%s" "--------------------------------------------------------------------"

printGameWithObstacles finished newObstacles

printfn "%i" (newObstacles |> List.distinct |> List.length)
